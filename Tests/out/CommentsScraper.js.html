<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: CommentsScraper.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: CommentsScraper.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * CommentScraper Module
 * @module CommentScraper
 */
define(['jquery', 'YQL', 'CommentType', 'Q', 'moment'], function($, yql, CommentType, q, moment) {
  var that = {};
  var commentsKarma = [];
  /**
   * Parses and retrieves information from a comment div html string
   * @param  {String} commentHtml - div from lesswrong submitted comments page which contains comment information
   * @return {Object} commentObj - contains comment: score, date, link, author, id and {@link CommentType}
   * @memberOf module:CommentScraper
   */
  that.getCommentObj = function(commentHtml) {
    // remove image tags so that they don't try to loaded when parsing
    var filteredCommentHtml = commentHtml.replace(/&lt;img[^>]*>/g, '');
    var domSelector = $(filteredCommentHtml);
    var commentNode = domSelector[0];
    var id = commentNode.id.replace('thingrow_', '');
    var authorNodes = $('#author_' + id, commentNode);
    var author = authorNodes.last().text();
    var score = parseInt($('#score_' + id, commentNode).first().text(), 10);
    var link = $('#permalink_' + id, commentNode).first().attr('href');
    var date = $('.comment-date', commentNode).first().text().replace('*', '').trim();
    var type = '';
    // finds out if the comment is being replied to by the user, i.e. a parent comment, or not (a leaf)
    if (domSelector.find('.comment').length === 0) {
      type = CommentType.Leaf;
    } else {
      type = CommentType.Parent;
    }

    return {
      y: score,
      x: moment.utc(date, 'DD MMMM YYYY hh:mm:ssA').valueOf(),
      link: link,
      author: author,
      id: id,
      commentType: type
    };
  };
  /**
   * Recursive function that retrieves information on all of a given users comments starting after an optional comment id
   * Each call processes a page with at most ten of the users comments
   * @param {String} user - the user whose comments will be processed
   * @param {String} [lastCommentId] - gets a page of comments after this comment id. If lastCommendId is not provided, the array that is retruned is reset to be empty. If it is provided, it is added to
   * @return {Array} commentsKarma - information extracted from all of the processed comments
   * @memberOf module:CommentScraper
   */
  that.scrapeUserComments = function(user, lastCommentId) {
    var url = 'http://lesswrong.com/user/' + encodeURIComponent(user) + '/comments/';
    if (lastCommentId) {
      url += '?count=' + commentsKarma.length + '&amp;after=' + lastCommentId;
    } else {
      commentsKarma = [];
    }
    return yql.getComments(url)
      .then(function(data) {
        if (data.results &amp;&amp; data.results.length > 0) {
          return q.all(data.results.map(function(commentHtml) {
            return that.getCommentObj(commentHtml);
          })).then(function(results) {
            var filteredResults = results.filter(function(result) {
              return result.author === user &amp;&amp; result.commentType === CommentType.Leaf;
            });
            commentsKarma = commentsKarma.concat(filteredResults);
            return that.scrapeUserComments(user, filteredResults[filteredResults.length - 1].id);
          });
        }
        return commentsKarma;
      });
  };
  return that;
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-ChartCreator.html">ChartCreator</a></li><li><a href="module-CommentScraper.html">CommentScraper</a></li><li><a href="module-CommentType.html">CommentType</a></li><li><a href="module-PostScraper.html">PostScraper</a></li><li><a href="module-PostType.html">PostType</a></li><li><a href="module-ProportionsChart.html">ProportionsChart</a></li><li><a href="module-Rounder.html">Rounder</a></li><li><a href="module-TimeSeriesChart.html">TimeSeriesChart</a></li><li><a href="module-TotalsChart.html">TotalsChart</a></li><li><a href="module-YQL.html">YQL</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Thu Feb 11 2016 11:06:31 GMT+1100 (AUS Eastern Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
