<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: PostsScraper.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: PostsScraper.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * PostScraper Module
 * @module PostScraper
 */
define(['jquery', 'YQL', 'PostType', 'Q', 'moment'], function($, yql, PostType, q, moment) {
  var that = {};
  var postsKarma = [];
  /**
   * Parses and retrieves post information from apost head div and meta div
   * @param  {String} header - div from lesswrong submitted posts page which contains the link to the post
   * @param  {String} meta - div from lesswrong submitted posts page which contains the date post was submitted, score it has and id
   * @return {Object} postObj - contains post: score, date, link, id and {@link PostType}
   * @memberOf module:PostScraper
   */
  that.getPostObj = function(header, meta) {
    var postLink = 'http://lesswrong.com/r/discussion' + $('a', header).attr('href');
    var postType = '';
    var metaNode = $(meta)[0];
    var date = $('.date', metaNode).text();
    var scoreNode = $('.votes > :nth-child(1)', metaNode);
    var id = scoreNode.first().attr('id').replace('score_', '').trim();
    var score = parseInt(scoreNode.text(), 10);

    return yql.getPostType(postLink)
      .then(function(data) {
        if (data.results &amp;&amp; data.results.length > 0) {
          postType = PostType.Discussion;
        } else {
          postType = PostType.Main;
          score *= 10;
        }
        var karma = {
          y: score,
          x: moment.utc(date, 'DD MMMM YYYY hh:mm:ssA').valueOf(),
          id: id,
          link: postLink,
          type: postType
        };
        return karma;
      });
  };
  /**
   * Recursive function that retrieves information on all of a given users post starting after an optional given post id
   * Each call processes a page with at most ten of the users post
   * @param {String} user - the user whose psots will be processed
   * @param {String} [lastPostId] - gets a page of posts after this comment id. If lastPostId is not provided, the array that is retruned is reset to be empty. If it is provided, it is added to
   * @return {Array} postsKarma - information extracted from all of the processed comments
   * @memberOf module:CommentScraper
   */
  that.scrapeUserPosts = function(user, lastPostId) {
    var url = 'http://lesswrong.com/user/' + encodeURIComponent(user) + '/submitted/';
    if (lastPostId) {
      url += '?after=' + lastPostId;
    } else {
      postsKarma = [];
    }

    return yql.getPosts(url)
      .then(function(data) {
        if (data.results &amp;&amp; data.results.length > 0) {
          var header = '';
          var promises = [];
          data.results.forEach(function(postItem, idx) {
            if (idx % 2 === 0) {
              header = postItem;
            } else {
              promises.push(that.getPostObj(header, postItem));
            }
          });
          return q.all(promises)
            .then(function(results) {
              postsKarma = postsKarma.concat(results);
              return that.scrapeUserPosts(user, results[results.length - 1].id);
            });
        }
        return postsKarma;
      });
  };
  return that;
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-ChartCreator.html">ChartCreator</a></li><li><a href="module-CommentScraper.html">CommentScraper</a></li><li><a href="module-CommentType.html">CommentType</a></li><li><a href="module-PostScraper.html">PostScraper</a></li><li><a href="module-PostType.html">PostType</a></li><li><a href="module-ProportionsChart.html">ProportionsChart</a></li><li><a href="module-Rounder.html">Rounder</a></li><li><a href="module-TimeSeriesChart.html">TimeSeriesChart</a></li><li><a href="module-TotalsChart.html">TotalsChart</a></li><li><a href="module-YQL.html">YQL</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Thu Feb 11 2016 11:06:31 GMT+1100 (AUS Eastern Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
